  - sensor:
      - name: "House Status"
        state: >
          {% set zone_occupied = states('zone.home') | default(0) | int > 0 %}
          {% set guests = is_state('input_boolean.guest_mode', 'on') %}
          {% set presence = is_state('binary_sensor.occupancy_livingroom', 'on') or is_state('binary_sensor.occupancy_frontroom', 'on') or is_state('binary_sensor.occupancy_study', 'on') or is_state('binary_sensor.occupancy_master', 'on') or is_state('binary_sensor.occupancy_sofia', 'on') or is_state('binary_sensor.occupancy_joseph', 'on') or is_state('binary_sensor.occupancy_theo', 'on') %}
          {% if zone_occupied or guests or presence %}
            Occupied
          {% else %}
            Vacant
          {% endif %}
        icon: >
          {% if is_state('sensor.house_status', 'Occupied') %}
            mdi:home-import-outline
          {% else %}
            mdi:home-export-outline
          {% endif %}

      - name: "Garage No Motion"
        state: '{{ ((as_timestamp(now()) - as_timestamp(states.binary_sensor.motion_garage.last_updated)) / 60) | int}}'
      - name: 'Calendar Location'
        state: >
          {% if states.calendar.family_family.attributes.location is defined %}
            {{ state.calendar.family_family.attributes.location }}
          {% else %}
            zone.sew
          {% endif %}
      - name: 'Power Heater Joseph'
        state: >
          {% if states.switch.heater_joseph.state == 'on' %}
            1200
          {% else %}
            0
          {% endif %}

  - trigger:
      - platform: state
        entity_id:
          - binary_sensor.motion_master
          - binary_sensor.motion_master_dsc
          - binary_sensor.motion_sofia
          - binary_sensor.motion_joseph
          - binary_sensor.motion_theo
          - binary_sensor.motion_theo_dsc
        from: "off"
        to: "on"
        id: bedroom
      - platform: state
        entity_id:
          - binary_sensor.motion_livingroom
          - binary_sensor.motion_frontroom
          - binary_sensor.motion_laundry
          - binary_sensor.motion_garage
          - binary_sensor.motion_garage_dsc
        from: "off"
        to: "on"
        id: common
    sensor:
      - unique_id: last_motion
        name: Last Motion
        icon: mdi:run-fast
        state: "{{ area_name(trigger.entity_id) }}"
        attributes:
          room_type: "{{ trigger.id | capitalize }}"
          trigger_entity: "{{ trigger.entity_id }}"

  - trigger:
      - platform: numeric_state
        entity_id: sensor.power_dishwasher
        above: 20
        id: cycle_start
      - platform: numeric_state
        entity_id: sensor.power_dishwasher
        below: 20
        id: cycle_end
      - platform: state
        entity_id: binary_sensor.door_dishwasher
        to: "on"
        id: door_opened
      - platform: state
        entity_id: switch.dishwasher
        id: switched
    sensor:
      - unique_id: dishwasher_state
        name: Dishwasher
        icon: mdi:dishwasher
        state: |
          {% if trigger.id == "door_opened" and is_state('sensor.dishwasher', 'Finished') %}
            Idle
          {% elif trigger.id == "cycle_start" %}
            Running
          {% elif trigger.id == "cycle_end" and is_state("sensor.dishwasher", "Running") and is_state('timer.dishwasher', 'idle') %}
            Finished
          {% elif  trigger.id == "switched" and is_state("switch.dishwasher", "off") %}
            Off
          {% elif  trigger.id == "switched" and is_state("switch.dishwasher", "on") %}
            {{ state_attr('sensor.dishwasher', 'last_state') }}
          {% else %}
            {{ states('sensor.dishwasher') }}
          {% endif %}
        attributes:
          last_state: |
            {{ states('sensor.dishwasher') }}

          
  - trigger:
      - platform: numeric_state
        entity_id: sensor.power_washingmachine
        above: 20
        id: cycle_start
      - platform: numeric_state
        entity_id: sensor.power_washingmachine
        below: 1
        id: cycle_end
      - platform: state
        entity_id: binary_sensor.door_washingmachine
        to: "on"
        id: door_opened
      - platform: state
        entity_id: switch.washing_machine
        id: switched
    sensor:
      - unique_id: washing_machine_state
        name: Washing Machine
        icon: mdi:washing-machine
        state: |
          {% if trigger.id == "door_opened" and is_state('sensor.washing_machine', 'Finished') %}
            Idle
          {% elif trigger.id == "cycle_start" %}
            Running
          {% elif trigger.id == "cycle_end" and is_state("sensor.washing_machine", "Running") %}
            Finished
          {% elif  trigger.id == "switched" and is_state("switch.washing_machine", "off") %}
            Off
          {% elif  trigger.id == "switched" and is_state("switch.washing_machine", "on") %}
            {{ state_attr('sensor.washing_machine', 'last_state') }}
          {% else %}
            {{ states("sensor.washing_machine") }}
          {% endif %}
        attributes:
          last_state: |
            {{ states('sensor.washing_machine') }}
            
  - trigger:
      - platform: state
        entity_id: sensor.power_simondesk
    binary_sensor:
      - name: Computer Simon
        unique_id: computer_simon
        state: "{{ int(states('sensor.power_simondesk')) > 45 }}"
        icon: |
          {% if int(states('sensor.power_simondesk')) > 45 %}
            mdi:monitor-dashboard
          {% else %}
            mdi:monitor
          {% endif %}

  - trigger:
      - platform: state
        entity_id: sensor.power_zoeydesk
    binary_sensor:
      - name: Computer Zoey
        unique_id: computer_zoey
        state: "{{ int(states('sensor.power_zoeydesk')) > 80 }}"
        icon: |
          {% if int(states('sensor.power_zoeydesk')) > 80 %}
            mdi:monitor-dashboard
          {% else %}
            mdi:monitor
          {% endif %}

  - trigger:
      - platform: template
        value_template: "{{ states('zone.home') == '1' }}"
        id: last
      - platform: template
        value_template: "{{ states('zone.home') == '0' }}"
        id: vacant
    sensor:
      - name: Last Home
        unique_id: last_home
        state: |
          {% if trigger.id == 'last' %}
            {{ state_attr(state_attr('zone.home', 'persons') | first, 'friendly_name') }}
          {% else %}
            {{ states('sensor.last_home') }}
          {% endif %}
        attributes:
          timestamp_last: |
            {% if trigger.id == 'vacant' %}
              {{ now() }}
            {% else %}
              {{ state_attr('sensor.last_home', 'timestamp_last') }}
            {% endif %}
          timestamp_second_last: |
            {% if trigger.id == 'last' %}
              {{ now() }}
            {% else %}
              {{ state_attr('sensor.last_home', 'timestamp_second_last') }}
            {% endif %}
          delta_minutes: |
            {% if trigger.id == 'vacant' %}
              {{ int((as_timestamp(now()) - as_timestamp(state_attr('sensor.last_home', 'timestamp_second_last'))) / 60) | abs }}
            {% else %}
              {{ state_attr('sensor.last_home', 'delta_minutes') }}
            {% endif %}

  - sensor:
      - name: Bin Distance
        state: "{{ float(state_attr('sensor.garbage_bin', 'distance')) }}"

  - trigger:
      - platform: state
        entity_id: sensor.power_simondesk_raw
        id: raw_data
      - platform: time_pattern
        seconds: "/7"
    sensor:
      - name: Power SimonDesk
        unique_id: power_simondesk
        unit_of_measurement: W
        device_class: power
        state: |
          {% if (states('sensor.power_simondesk_raw') | float(0)) == 0 %}
            {% if (state_attr('sensor.power_simondesk', 'previous_raw_value') | float(0) == 0) %}
              0
            {% else %}
              {{ states('sensor.power_simondesk') }}
            {% endif %}
          {% else %}
            {{ states('sensor.power_simondesk_raw') }}
          {% endif %}
        attributes:
          raw_value: |
            {{ states('sensor.power_simondesk_raw') }}
          previous_raw_value: |
            {{ state_attr('sensor.power_simondesk', 'raw_value') }}
            
  - trigger:
      - platform: state
        entity_id: sensor.power_zoeydesk_raw
        id: raw_data
      - platform: time_pattern
        seconds: "/7"
    sensor:
      - name: Power ZoeyDesk
        unique_id: power_zoeydesk
        unit_of_measurement: W
        device_class: power
        state: |
          {% if (states('sensor.power_zoeydesk_raw') | float(0)) == 0 %}
            {% if (state_attr('sensor.power_zoeydesk', 'previous_raw_value') | float(0) == 0) %}
              0
            {% else %}
              {{ states('sensor.power_zoeydesk') }}
            {% endif %}
          {% else %}
            {{ states('sensor.power_zoeydesk_raw') }}
          {% endif %}
        attributes:
          raw_value: |
            {{ states('sensor.power_zoeydesk_raw') }}
          previous_raw_value: |
            {{ state_attr('sensor.power_zoeydesk', 'raw_value') }}

  - trigger:
      - platform: state
        entity_id: sensor.power_washingmachine_raw
        id: raw_data
      - platform: time_pattern
        seconds: "/7"
    sensor:
      - name: Power WashingMachine
        unique_id: power_washingmachine
        unit_of_measurement: W
        device_class: power
        state: |
          {% if (states('sensor.power_washingmachine_raw') | float(0)) == 0 %}
            {% if (state_attr('sensor.power_washingmachine', 'previous_raw_value') | float(0) == 0) %}
              0
            {% else %}
              {{ states('sensor.power_washingmachine') }}
            {% endif %}
          {% else %}
            {{ states('sensor.power_washingmachine_raw') }}
          {% endif %}
        attributes:
          raw_value: |
            {{ states('sensor.power_washingmachine_raw') }}
          previous_raw_value: |
            {{ state_attr('sensor.power_washingmachine', 'raw_value') }}

  - trigger:
      - platform: state
        entity_id: sensor.power_dishwasher_raw
        id: raw_data
      - platform: time_pattern
        seconds: "/7"
    sensor:
      - name: Power Dishwasher
        unique_id: power_dishwasher
        unit_of_measurement: W
        device_class: power
        state: |
          {% if (states('sensor.power_dishwasher_raw') | float(0)) == 0 %}
            {% if (state_attr('sensor.power_dishwasher', 'previous_raw_value') | float(0) == 0) %}
              0
            {% else %}
              {{ states('sensor.power_dishwasher') }}
            {% endif %}
          {% else %}
            {{ states('sensor.power_dishwasher_raw') }}
          {% endif %}
        attributes:
          raw_value: |
            {{ states('sensor.power_dishwasher_raw') }}
          previous_raw_value: |
            {{ state_attr('sensor.power_dishwasher', 'raw_value') }}
 

